<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Deutsch Lernen ‚Äî Trilingual</title>
<meta name="theme-color" content="#0ea5e9">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='1' y2='0'%3E%3Cstop stop-color='%230f172a'/%3E%3Cstop stop-color='%230ea5e9' offset='.9'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='22' fill='url(%23g)'/%3E%3Ctext x='50' y='60' font-size='44' text-anchor='middle' fill='white' font-family='Inter, Arial, sans-serif'%3EDE%3C/text%3E%3C/svg%3E">
<style>
:root{
  --primary:#0ea5e9; --primary-dark:#0284c7;
  --bg:#0b1020; --surface:#0f172a; --card:#101827;
  --text:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee;
  --ok:#22c55e; --warn:#f59e0b; --r:16px;
  --shadow:0 10px 30px rgba(0,0,0,.25)
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text); background:radial-gradient(1200px 800px at 10% -10%, #0b3a5a33, transparent 60%), linear-gradient(180deg,#0b1020 0,#0b1020 260px,#0b1325 100%)
}
.container{max-width:1100px;padding:18px;margin:0 auto}
.header{
  position:sticky;top:0;z-index:50;backdrop-filter: blur(6px);
  background:linear-gradient(180deg,#08111fdd,#08111f88 70%,transparent);
}
.brand{
  display:flex;align-items:center;gap:12px;padding:14px 6px 8px
}
.brand h1{margin:0;font-weight:800;letter-spacing:.3px}
.logo{
  width:46px;height:46px;border-radius:50%;
  background:linear-gradient(135deg,var(--primary),#38bdf8 70%);
  box-shadow:0 4px 16px #0ea5e944; display:grid;place-items:center;color:white;font-weight:800
}
.lang-switch, .nav{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center
}
.lang-switch button, .nav button, .chip, .btn{
  border:1px solid #1f2a44;background:#0e162d;color:var(--text);
  padding:8px 12px;border-radius:999px;cursor:pointer;
  transition:.2s box-shadow,.2s background,.2s transform;font-weight:600
}
.lang-switch button.active, .nav button.active{background:var(--primary);border-color:var(--primary);color:white;box-shadow:0 6px 20px #0ea5e944}
.lang-switch{margin-left:auto}
.header-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.nav{padding:8px 0}
.search{display:flex;gap:10px;align-items:center;margin:10px 0 0}
.search input{
  width:min(520px,100%); padding:12px 14px;border-radius:14px;border:1px solid #1f2a44;background:#0e162d;color:var(--text)
}
.btn{background:#122041;border-color:#1f2a44}
.btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
.btn.ghost{background:transparent}
.grid{
  display:grid;grid-template-columns:repeat(12,1fr); gap:16px;margin-top:14px
}
.card{
  grid-column:span 12;background:linear-gradient(180deg,#0f1a33,#0e162d);
  border:1px solid #1f2a44;border-radius:20px;padding:16px;box-shadow:var(--shadow)
}
.card h3{margin:0 0 10px}
.badge{display:inline-flex;gap:8px;align-items:center;background:#0a162e;border:1px solid #1f2a44;color:#9ecff8;padding:6px 10px;border-radius:12px;font-size:.88rem}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.lesson, .dict-item, .dialog-item{
  border:1px solid #1f2a44;border-radius:16px;padding:12px 14px;background:#0d1730
}
.lesson{display:flex;gap:12px;align-items:flex-start}
.lesson .title{font-weight:700}
.kicker{color:var(--muted);font-size:.86rem}
.dict-head{display:flex;gap:8px;align-items:center;justify-content:space-between}
.dict-body{display:grid;grid-template-columns:repeat(1, minmax(0,1fr)); gap:10px;margin-top:10px}
.tag{padding:4px 8px;border:1px solid #1f2a44;background:#0b1a31;border-radius:999px;color:#a5b4fc;font-size:.8rem}
.favorite{cursor:pointer}
hr.sep{border:0;border-top:1px dashed #203050;margin:14px 0}
.flashcard{
  height:190px;border-radius:18px;background:linear-gradient(160deg,#0e3c60,#0b2744 60%);
  color:#e8f5ff;display:grid;place-items:center;font-size:1.2rem;font-weight:700;
  border:1px solid #1e3a5f;box-shadow:var(--shadow); user-select:none; text-align:center;padding:16px
}
.controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:12px;flex-wrap:wrap}
select, .select{
  padding:10px 12px;border-radius:12px;border:1px solid #1f2a44;background:#0e162d;color:var(--text)
}
.small{font-size:.86rem;color:var(--muted)}
.right{margin-left:auto}
footer{opacity:.8;margin:40px 0 30px;text-align:center;font-size:.9rem;color:#9fb6d1}
@media (min-width:700px){
  .card.span-6{grid-column:span 6}
  .card.span-4{grid-column:span 4}
  .dict-body{grid-template-columns:repeat(2, minmax(0,1fr))}
}
@media (min-width:980px){
  .dict-body{grid-template-columns:repeat(3, minmax(0,1fr))}
}
</style>
</head>
<body>
<header class="header">
  <div class="container">
    <div class="header-row">
      <div class="brand">
        <div class="logo">DE</div>
        <h1 id="appTitle">Deutsch Lernen</h1>
        <span class="badge" id="badgeTag">–¢—Ä–∏ —è–∑—ã–∫–∞</span>
      </div>
      <div class="lang-switch" role="tablist" aria-label="Language switch">
        <button data-lang="ru" class="active">RU</button>
        <button data-lang="de">DE</button>
        <button data-lang="az">AZ</button>
      </div>
    </div>

    <div class="row">
      <nav class="nav" id="navTabs">
        <button data-tab="lessons" class="active">–£—Ä–æ–∫–∏</button>
        <button data-tab="dictionary">–°–ª–æ–≤–∞—Ä—å</button>
        <button data-tab="flashcards">–ö–∞—Ä—Ç–æ—á–∫–∏</button>
        <button data-tab="grammar">–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞</button>
        <button data-tab="dialogs">–î–∏–∞–ª–æ–≥–∏</button>
      </nav>
      <div class="search right">
        <input id="searchInput" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤–∞—Ä—é‚Ä¶" />
        <button class="btn" id="speakBtn" title="–û–∑–≤—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É">üîä</button>
      </div>
    </div>
  </div>
</header>

<main class="container" id="views">
  <!-- LESSONS -->
  <section id="view-lessons" class="grid">
    <div class="card span-6">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 data-i="l_greetings">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ</h3>
        <span class="kicker" id="lessCount">5 —É—Ä–æ–∫(–æ–≤)</span>
      </div>
      <div id="lessonsList" class="col"></div>
    </div>

    <div class="card span-6">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 data-i="l_basics">–û—Å–Ω–æ–≤—ã</h3>
        <span class="kicker" id="progStat">0% ‚Ä¢ 0/0</span>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <span class="chip">Alphabet ‚Ä¢ A1</span>
        <span class="chip">Numbers ‚Ä¢ A1</span>
        <span class="chip">Days & Time ‚Ä¢ A1</span>
        <span class="chip">Cases intro ‚Ä¢ A2</span>
      </div>
      <hr class="sep">
      <div class="row">
        <button class="btn primary" id="startQuick">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</button>
        <button class="btn ghost" id="resetProgress">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        <span class="small right" id="saveHint">–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ</span>
      </div>
    </div>
  </section>

  <!-- DICTIONARY -->
  <section id="view-dictionary" class="grid" hidden>
    <div class="card">
      <div class="dict-head">
        <h3 data-i="d_title">–°–ª–æ–≤–∞—Ä—å</h3>
        <div class="row">
          <select id="dictTopic"></select>
          <button class="btn" id="exportCSV">CSV</button>
        </div>
      </div>
      <div class="dict-body" id="dictBody"></div>
    </div>
  </section>

  <!-- FLASHCARDS -->
  <section id="view-flashcards" class="grid" hidden>
    <div class="card span-6">
      <div class="row" style="justify-content:space-between">
        <h3 data-i="f_title">–ö–∞—Ä—Ç–æ—á–∫–∏</h3>
        <div class="row">
          <label class="small" for="fcTopic" data-i="topic">–¢–µ–º–∞</label>
          <select id="fcTopic" class="select"></select>
        </div>
      </div>
      <div class="flashcard" id="flashcard" tabindex="0" aria-live="polite">‚Äî</div>
      <div class="controls">
        <button class="btn" id="prevCard">‚óÄ</button>
        <span id="fcPos" class="small">0/0</span>
        <button class="btn" id="nextCard">‚ñ∂</button>
        <button class="btn" id="flipCard" data-i="flip">–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</button>
        <button class="btn" id="ttsCard">üîä</button>
        <button class="btn" id="favCard">‚òÖ</button>
        <button class="btn" id="shuffleCard">üîÄ</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="small">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å:</label>
        <select id="fcSide" class="select">
          <option value="front">DE ‚Üí (RU/AZ)</option>
          <option value="back">(RU/AZ) ‚Üí DE</option>
          <option value="mix">–°–º–µ—à–∞—Ç—å</option>
        </select>
      </div>
    </div>

    <div class="card span-6">
      <h3 data-i="fav">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h3>
      <div id="favorites" class="dict-body"></div>
    </div>
  </section>

  <!-- GRAMMAR -->
  <section id="view-grammar" class="grid" hidden>
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 data-i="g_title">–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞</h3>
        <div>
          <select id="gramTopic"></select>
        </div>
      </div>
      <article id="grammarBody"></article>
    </div>
  </section>

  <!-- DIALOGS -->
  <section id="view-dialogs" class="grid" hidden>
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 data-i="dlg_title">–î–∏–∞–ª–æ–≥–∏</h3>
        <div class="row">
          <select id="dlgTopic"></select>
          <button class="btn" id="playDlg">‚ñ∂</button>
        </div>
      </div>
      <div id="dialogsList" class="dict-body"></div>
    </div>
  </section>
</main>

<footer>
  ¬© <span id="year"></span> Deutsch Lernen ‚Ä¢ <span id="footLang">–†—É—Å—Å–∫–∏–π</span> / Deutsch / Az…ôrbaycan. 
  <span class="small">–û—Ñ—Ñ–ª–∞–π–Ω-—Ä–∞–±–æ—Ç–∞: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</span>
</footer>

<script>
/* ========= –ú–£–õ–¨–¢–ò–Ø–ó–´–ß–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° ========= */
const UI = {
  ru:{
    title:"Deutsch Lernen", tag:"–¢—Ä–∏ —è–∑—ã–∫–∞",
    tabs:{lessons:"–£—Ä–æ–∫–∏", dictionary:"–°–ª–æ–≤–∞—Ä—å", flashcards:"–ö–∞—Ä—Ç–æ—á–∫–∏", grammar:"–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", dialogs:"–î–∏–∞–ª–æ–≥–∏"},
    l_greetings:"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ", l_basics:"–û—Å–Ω–æ–≤—ã",
    d_title:"–°–ª–æ–≤–∞—Ä—å", f_title:"–ö–∞—Ä—Ç–æ—á–∫–∏", topic:"–¢–µ–º–∞", flip:"–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å", fav:"–ò–∑–±—Ä–∞–Ω–Ω–æ–µ",
    g_title:"–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", dlg_title:"–î–∏–∞–ª–æ–≥–∏",
    placeholders:{search:"–ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤–∞—Ä—é‚Ä¶"},
    voiceHint:"–°–∫–∞–∂–∏: ¬´–û–∑–≤—É—á—å —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É¬ª",
    foot:"–†—É—Å—Å–∫–∏–π"
  },
  de:{
    title:"Deutsch Lernen", tag:"Dreisprachig",
    tabs:{lessons:"Lektionen", dictionary:"W√∂rterbuch", flashcards:"Karten", grammar:"Grammatik", dialogs:"Dialoge"},
    l_greetings:"Begr√º√üung & Kennenlernen", l_basics:"Grundlagen",
    d_title:"W√∂rterbuch", f_title:"Karten", topic:"Thema", flip:"Umdrehen", fav:"Favoriten",
    g_title:"Grammatik", dlg_title:"Dialoge",
    placeholders:{search:"Im W√∂rterbuch suchen‚Ä¶"},
    voiceHint:"Sag: ‚ÄûLies die aktuelle Karte vor‚Äú",
    foot:"Deutsch"
  },
  az:{
    title:"Deutsch Lernen", tag:"√ú√ß dilli",
    tabs:{lessons:"D…ôrsl…ôr", dictionary:"L√ºƒü…ôt", flashcards:"Kartlar", grammar:"Qrammatika", dialogs:"Dialoqlar"},
    l_greetings:"Salamla≈üma v…ô tanƒ±≈ülƒ±q", l_basics:"∆èsaslar",
    d_title:"L√ºƒü…ôt", f_title:"Kartlar", topic:"M√∂vzu", flip:"√áevir", fav:"Se√ßilmi≈ül…ôr",
    g_title:"Qrammatika", dlg_title:"Dialoqlar",
    placeholders:{search:"L√ºƒü…ôtd…ô axtarƒ±≈ü‚Ä¶"},
    voiceHint:"De: ‚ÄúKartƒ± s…ôsl…ôndir‚Äù",
    foot:"Az…ôrbaycan"
  }
};
let lang = localStorage.getItem("ui-lang") || "ru";
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);

/* ========= –î–ê–ù–ù–´–ï (–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å) ========= */
const topics = {
  greetings:{
    name:{ru:"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è", de:"Begr√º√üung", az:"Salamla≈üma"},
    words:[
      {de:"Guten Morgen!", ru:"–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!", az:"Sabahƒ±nƒ±z xeyir!"},
      {de:"Guten Tag!", ru:"–î–æ–±—Ä—ã–π –¥–µ–Ω—å!", az:"G√ºnortanƒ±z xeyir!"},
      {de:"Guten Abend!", ru:"–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!", az:"Ax≈üamƒ±nƒ±z xeyir!"},
      {de:"Wie geht's?", ru:"–ö–∞–∫ –¥–µ–ª–∞?", az:"Nec…ôs…ôn?"},
      {de:"Danke, gut.", ru:"–°–ø–∞—Å–∏–±–æ, —Ö–æ—Ä–æ—à–æ.", az:"Saƒü ol, yax≈üƒ±."},
      {de:"Ich hei√üe ‚Ä¶", ru:"–ú–µ–Ω—è –∑–æ–≤—É—Ç ‚Ä¶", az:"M…ônim adƒ±m ‚Ä¶"}
    ],
    dialogs:[
      {title:{ru:"–ü–µ—Ä–≤–æ–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ",de:"Erstes Kennenlernen",az:"ƒ∞lk tanƒ±≈ülƒ±q"},
       lines:[
        {role:"A", de:"Hallo! Ich hei√üe Aylin. Wie hei√üt du?", ru:"–ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–π–ª–∏–Ω. –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?", az:"Salam! M…ônim adƒ±m Aylindir. S…ônin adƒ±n n…ôdir?"},
        {role:"B", de:"Ich hei√üe Samir. Freut mich!", ru:"–ú–µ–Ω—è –∑–æ–≤—É—Ç –°–∞–º–∏—Ä. –ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è!", az:"M…ônim adƒ±m Samirdir. Tanƒ±≈ü olduƒüuma ≈üadam!"},
        {role:"A", de:"Wie geht‚Äôs dir?", ru:"–ö–∞–∫ –¥–µ–ª–∞?", az:"Nec…ôs…ôn?"},
        {role:"B", de:"Danke, gut. Und dir?", ru:"–°–ø–∞—Å–∏–±–æ, —Ö–æ—Ä–æ—à–æ. –ê —É —Ç–µ–±—è?", az:"Saƒü ol, yax≈üƒ±. S…ônd…ô nec…ô?"}
       ]
      }
    ],
    grammar:[
      {title:{ru:"–ü—Ä–µ–¥–∏–∫–∞—Ç–∏–≤ sein: ich bin ‚Ä¶", de:"Pr√§dikativ mit sein", az:"‚ÄòSein‚Äô felinin istifad…ôsi"},
       html:{
        ru:`<p><b>sein</b> ‚Äî –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≥–ª–∞–≥–æ–ª ‚Äò–±—ã—Ç—å‚Äô. –§–æ—Ä–º—ã: <code>ich bin, du bist, er/sie/es ist, wir sind, ihr seid, sie/Sie sind</code>.</p>
            <ul><li>Ich <b>bin</b> Samir.</li><li>Du <b>bist</b> Aylin.</li></ul>`,
        de:`<p><b>sein</b> (ich bin, du bist, er/sie/es ist ‚Ä¶). Beispiele: Ich <b>bin</b> Samir. Du <b>bist</b> Aylin.</p>`,
        az:`<p><b>sein</b> feilinin formalarƒ±: <code>ich bin, du bist, er/sie/es ist ‚Ä¶</code>. Misal: M…ôn <b>Samir…ôm</b>.</p>`
       }}
    ],
    lessons:[
      {title:{ru:"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?",de:"Hallo! Wie hei√üen Sie?",az:"Salam! Adƒ±nƒ±z n…ôdir?"},
       points:[
        {de:"Ich hei√üe Samir.", ru:"–ú–µ–Ω—è –∑–æ–≤—É—Ç –°–∞–º–∏—Ä.", az:"M…ônim adƒ±m Samirdir."},
        {de:"Wie geht‚Äôs?", ru:"–ö–∞–∫ –¥–µ–ª–∞?", az:"Nec…ôs…ôn?"},
        {de:"Freut mich!", ru:"–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è!", az:"Tanƒ±≈ü olduƒüuma ≈üadam!"}
       ]},
      {title:{ru:"–ö–∞–∫ –¥–µ–ª–∞?",de:"Wie geht's?",az:"Nec…ôs…ôn?"},
       points:[
        {de:"Danke, gut.", ru:"–°–ø–∞—Å–∏–±–æ, —Ö–æ—Ä–æ—à–æ.", az:"Saƒü ol, yax≈üƒ±."},
        {de:"Und dir?", ru:"–ê —É —Ç–µ–±—è?", az:"B…ôs s…ôn?"}
       ]}
    ]
  },
  work:{
    name:{ru:"–†–∞–±–æ—Ç–∞", de:"Arbeit", az:"ƒ∞≈ü"},
    words:[
      {de:"der Beruf", ru:"–ø—Ä–æ—Ñ–µ—Å—Å–∏—è", az:"pe≈ü…ô"},
      {de:"die Arbeit", ru:"—Ä–∞–±–æ—Ç–∞", az:"i≈ü"},
      {de:"der Kollege", ru:"–∫–æ–ª–ª–µ–≥–∞ (–º.)", az:"h…ômkar (ki≈üi)"},
      {de:"die Kollegin", ru:"–∫–æ–ª–ª–µ–≥–∞ (–∂.)", az:"h…ômkar (qadƒ±n)"},
      {de:"das B√ºro", ru:"–æ—Ñ–∏—Å", az:"ofis"},
      {de:"die Aufgabe", ru:"–∑–∞–¥–∞—á–∞", az:"tap≈üƒ±rƒ±q"}
    ],
    dialogs:[
      {title:{ru:"–ù–∞ –Ω–æ–≤–æ–π —Ä–∞–±–æ—Ç–µ",de:"Im neuen Job",az:"Yeni i≈üd…ô"},
       lines:[
        {role:"A", de:"Wo arbeitest du?", ru:"–ì–¥–µ —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å?", az:"Harada i≈ül…ôyirs…ôn?"},
        {role:"B", de:"Ich arbeite im B√ºro als Verk√§ufer.", ru:"–Ø —Ä–∞–±–æ—Ç–∞—é –≤ –æ—Ñ–∏—Å–µ –ø—Ä–æ–¥–∞–≤—Ü–æ–º.", az:"M…ôn ofisd…ô satƒ±cƒ± kimi i≈ül…ôyir…ôm."}
       ]}
    ],
    grammar:[
      {title:{ru:"–ì–ª–∞–≥–æ–ª—ã —Å –ª–∏—á–Ω—ã–º–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è–º–∏",de:"Personalendungen",az:"≈û…ôxs sonluqlarƒ±"},
       html:{
        ru:`<p>–û–±—ã—á–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã –≤ Pr√§sens: <code>ich -e, du -st, er/sie/es -t, wir -en, ihr -t, sie/Sie -en</code>.</p>`,
        de:`<p>Pr√§sens-Endungen: <code>-e, -st, -t, -en, -t, -en</code>.</p>`,
        az:`<p>ƒ∞ndiki zamanda feil sonluqlarƒ±: <code>-e, -st, -t, -en, -t, -en</code>.</p>`
       }}
    ],
    lessons:[
      {title:{ru:"–†–∞—Å—Å–∫–∞–∑ –æ —Ä–∞–±–æ—Ç–µ",de:"√úber die Arbeit erz√§hlen",az:"ƒ∞≈ü haqqƒ±nda danƒ±≈ü"},
       points:[
        {de:"Ich arbeite als Fahrer.", ru:"–Ø —Ä–∞–±–æ—Ç–∞—é –≤–æ–¥–∏—Ç–µ–ª–µ–º.", az:"M…ôn s√ºr√ºc√º i≈ül…ôyir…ôm."},
        {de:"Meine Aufgaben sind ‚Ä¶", ru:"–ú–æ–∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ ‚Ä¶", az:"M…ônim v…ôzif…ôl…ôrim ‚Ä¶"}
       ]}
    ]
  }
};
const topicKeys = Object.keys(topics);

/* ========= –°–û–°–¢–û–Ø–ù–ò–ï ========= */
const state = {
  tab:"lessons",
  ui: UI[lang],
  flash:{
    topic: topicKeys[0],
    idx:0, side:"front", order:[],
    favorites: JSON.parse(localStorage.getItem("fav-cards")||"[]")
  },
  progress: JSON.parse(localStorage.getItem("progress")||"{}")
};

/* ========= –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –Ø–ó–´–ö–ê UI ========= */
function applyUI(){
  document.documentElement.lang = lang;
  state.ui = UI[lang];
  $("#appTitle").textContent = state.ui.title;
  $("#badgeTag").textContent = state.ui.tag;
  $$("#navTabs button").forEach(b=>{
    const k=b.dataset.tab;
    b.textContent = state.ui.tabs[k];
    b.classList.toggle("active", state.tab===k);
  });
  $("[data-i='l_greetings']").textContent = state.ui.l_greetings;
  $("[data-i='l_basics']").textContent = state.ui.l_basics;
  $("[data-i='d_title']").textContent = state.ui.d_title;
  $("[data-i='f_title']").textContent = state.ui.f_title;
  $("[data-i='topic']").textContent  = state.ui.topic;
  $("[data-i='flip']").textContent   = state.ui.flip;
  $("[data-i='fav']").textContent    = state.ui.fav;
  $("[data-i='g_title']").textContent= state.ui.g_title;
  $("[data-i='dlg_title']").textContent= state.ui.dlg_title;
  $("#searchInput").placeholder = state.ui.placeholders.search;
  $("#footLang").textContent = state.ui.foot;

  buildLessons(); buildDictionary(); buildFlashcards(); buildGrammar(); buildDialogs();
}
document.querySelectorAll(".lang-switch button").forEach(b=>{
  b.addEventListener("click", ()=>{
    document.querySelectorAll(".lang-switch button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    lang = b.dataset.lang; localStorage.setItem("ui-lang", lang);
    applyUI();
  });
});

/* ========= –ù–ê–í–ò–ì–ê–¶–ò–Ø ========= */
document.querySelectorAll("#navTabs button").forEach(b=>{
  b.addEventListener("click", ()=>{
    state.tab = b.dataset.tab;
    document.querySelectorAll("#navTabs button").forEach(x=>x.classList.toggle("active", x===b));
    ["lessons","dictionary","flashcards","grammar","dialogs"].forEach(id=>{
      $("#view-"+id).hidden = id!==state.tab;
    });
  });
});

/* ========= –£–†–û–ö–ò ========= */
function buildLessons(){
  const wrap = $("#lessonsList"); wrap.innerHTML="";
  const all = [];
  topicKeys.forEach(tk=>{
    topics[tk].lessons?.forEach(ls=> all.push({tk,ls}));
  });
  $("#lessCount").textContent = all.length+" —É—Ä–æ–∫(–æ–≤)";
  all.forEach(({tk,ls})=>{
    const el = document.createElement("div");
    el.className="lesson";
    const ch = (state.progress[tk]?.[ls.title.de])? "‚úÖ":"‚≠ï";
    el.innerHTML = `
      <div style="font-size:24px">${ch}</div>
      <div>
        <div class="kicker">${topics[tk].name[lang]||topics[tk].name.ru}</div>
        <div class="title">${ls.title[lang]||ls.title.ru}</div>
        <ul style="margin:8px 0 0;padding-left:18px">
          ${ls.points.map(p=>`<li>${p.de} ‚Äî <span class="small">${p[lang]||p.ru}</span></li>`).join("")}
        </ul>
        <div class="row" style="margin-top:8px;gap:8px">
          <button class="btn primary" data-done="${tk}|${ls.title.de}">–û—Ç–º–µ—Ç–∏—Ç—å</button>
          <button class="btn" data-tts="${ls.points[0].de}">üîä</button>
        </div>
      </div>`;
    wrap.appendChild(el);
  });
  wrap.querySelectorAll("[data-done]").forEach(btn=>{
    btn.onclick=()=>{
      const [tk,key] = btn.dataset.done.split("|");
      state.progress[tk] = state.progress[tk]||{};
      state.progress[tk][key]=true;
      localStorage.setItem("progress", JSON.stringify(state.progress));
      buildLessons(); updateProgStat();
    }
  });
  wrap.querySelectorAll("[data-tts]").forEach(btn=>{
    btn.onclick=()=> speak(btn.dataset.tts,"de-DE");
  });
  updateProgStat();
}
function updateProgStat(){
  const all=[]; const done=[];
  topicKeys.forEach(tk=>{
    topics[tk].lessons?.forEach(ls=>{
      all.push(ls.title.de);
      if(state.progress[tk]?.[ls.title.de]) done.push(ls.title.de);
    });
  });
  const pct = all.length? Math.round(done.length/all.length*100):0;
  $("#progStat").textContent = `${pct}% ‚Ä¢ ${done.length}/${all.length}`;
}
$("#startQuick").onclick=()=>{ state.tab="flashcards"; document.querySelectorAll("#navTabs button")[2].click(); };
$("#resetProgress").onclick=()=>{ if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")){ localStorage.removeItem("progress"); state.progress={}; buildLessons(); } };

/* ========= –°–õ–û–í–ê–†–¨ ========= */
function buildDictionary(){
  const sel = $("#dictTopic"); sel.innerHTML="";
  topicKeys.forEach(k=>{
    const o=document.createElement("option");
    o.value=k; o.textContent = topics[k].name[lang]||topics[k].name.ru;
    sel.appendChild(o);
  });
  sel.value = sel.value || topicKeys[0];
  renderDict(sel.value);

  sel.onchange = ()=> renderDict(sel.value);
  $("#searchInput").oninput = ()=> renderDict(sel.value, $("#searchInput").value.trim());
  $("#exportCSV").onclick = ()=> exportCSV(sel.value);
}
function renderDict(tk, q=""){
  const box = $("#dictBody"); box.innerHTML="";
  const data = topics[tk].words.filter(w=>{
    if(!q) return true;
    q=q.toLowerCase();
    return w.de.toLowerCase().includes(q) || (w[lang]||w.ru).toLowerCase().includes(q);
  });
  data.forEach(w=>{
    const it=document.createElement("div"); it.className="dict-item";
    const favId = `${w.de}|${w.ru}`;
    const isFav = state.flash.favorites.some(x=>x.id===favId);
    it.innerHTML = `
      <div class="row" style="justify-content:space-between;gap:12px">
        <div><b>${w.de}</b><div class="small">${w[lang]||w.ru}</div></div>
        <div class="row">
          <button class="btn" title="–û–∑–≤—É—á–∏—Ç—å" data-say="${w.de}">üîä</button>
          <button class="btn favorite" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" data-fav='${JSON.stringify({...w,id:favId})}'>${isFav?"‚òÖ":"‚òÜ"}</button>
        </div>
      </div>`;
    box.appendChild(it);
  });
  box.querySelectorAll("[data-say]").forEach(b=> b.onclick=()=> speak(b.dataset.say,"de-DE"));
  box.querySelectorAll("[data-fav]").forEach(b=> b.onclick=()=>{
    const item = JSON.parse(b.dataset.fav);
    const idx = state.flash.favorites.findIndex(x=>x.id===item.id);
    if(idx>-1) state.flash.favorites.splice(idx,1); else state.flash.favorites.push(item);
    localStorage.setItem("fav-cards", JSON.stringify(state.flash.favorites));
    buildFlashcards(); renderDict(tk, $("#searchInput").value.trim());
  });
}
function exportCSV(tk){
  const rows = [["DE", lang.toUpperCase()]];
  topics[tk].words.forEach(w=> rows.push([w.de, w[lang]||w.ru]));
  const csv = rows.map(r=> r.map(x=> `"${(x||"").replaceAll('"','""')}"`).join(",")).join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download=`${topics[tk].name[lang]||topics[tk].name.ru}.csv`;
  a.click();
}

/* ========= –ö–ê–†–¢–û–ß–ö–ò ========= */
function buildFlashcards(){
  const sel = $("#fcTopic"); sel.innerHTML="";
  topicKeys.forEach(k=>{
    const o=document.createElement("option");
    o.value=k; o.textContent = topics[k].name[lang]||topics[k].name.ru;
    sel.appendChild(o);
  });
  if(!topics[state.flash.topic]) state.flash.topic = topicKeys[0];
  sel.value = state.flash.topic;
  sel.onchange = ()=>{ state.flash.topic=sel.value; resetDeck(); drawCard(); };

  $("#fcSide").value = state.flash.side; 
  $("#fcSide").onchange = ()=>{ state.flash.side=$("#fcSide").value; drawCard(); };

  $("#prevCard").onclick=()=> move(-1);
  $("#nextCard").onclick=()=> move(1);
  $("#flipCard").onclick=()=> flip();
  $("#shuffleCard").onclick=()=>{ shuffleDeck(); drawCard(); };
  $("#ttsCard").onclick=()=> sayCurrent();
  $("#favCard").onclick=()=> toggleFavCurrent();

  resetDeck();
  drawCard();
  renderFavorites();
}
function deckData(){
  return topics[state.flash.topic].words.map(w=>({front:w.de, back:w[lang]||w.ru, raw:w}));
}
function resetDeck(){
  state.flash.idx=0;
  const arr = deckData();
  state.flash.order = [...arr.keys()];
  shuffleDeck();
}
function shuffleDeck(){
  for(let i=state.flash.order.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [state.flash.order[i],state.flash.order[j]]=[state.flash.order[j],state.flash.order[i]];
  }
}
function drawCard(){
  const data = deckData();
  const total = data.length;
  if(total===0){ $("#flashcard").textContent="‚Äî"; $("#fcPos").textContent="0/0"; return; }
  if(state.flash.idx<0) state.flash.idx=total-1;
  if(state.flash.idx>=total) state.flash.idx=0;

  const item = data[state.flash.order[state.flash.idx]];
  const mode = state.flash.side==="mix" ? (Math.random()<.5 ? "front":"back") : state.flash.side;
  $("#flashcard").dataset.show = mode;
  $("#flashcard").textContent = (mode==="front") ? item.front : item.back;
  $("#fcPos").textContent = `${state.flash.idx+1}/${total}`;
}
function move(d){ state.flash.idx += d; drawCard(); }
function flip(){
  const fc=$("#flashcard");
  fc.dataset.show = (fc.dataset.show==="front")?"back":"front";
  const item = deckData()[state.flash.order[state.flash.idx]];
  fc.textContent = (fc.dataset.show==="front")? item.front : item.back;
}
function sayCurrent(){
  const item = deckData()[state.flash.order[state.flash.idx]];
  const text = ($("#flashcard").dataset.show==="front")? item.front : item.raw.de; // –≤—Å–µ–≥–¥–∞ –Ω–µ–º–µ—Ü–∫–∏–π –¥–ª—è –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è
  speak(text,"de-DE");
}
function toggleFavCurrent(){
  const item = deckData()[state.flash.order[state.flash.idx]].raw;
  const id = `${item.de}|${item.ru}`;
  const idx = state.flash.favorites.findIndex(x=>x.id===id);
  if(idx>-1) state.flash.favorites.splice(idx,1);
  else state.flash.favorites.push({...item, id});
  localStorage.setItem("fav-cards", JSON.stringify(state.flash.favorites));
  renderFavorites();
}
function renderFavorites(){
  const box=$("#favorites"); box.innerHTML="";
  state.flash.favorites.forEach(f=>{
    const it=document.createElement("div"); it.className="dict-item";
    it.innerHTML=`<div class="row" style="justify-content:space-between">
      <div><b>${f.de}</b><div class="small">${f[lang]||f.ru}</div></div>
      <div class="row">
        <button class="btn" data-say="${f.de}">üîä</button>
        <button class="btn" data-rem="${f.id}">‚úï</button>
      </div>
    </div>`;
    box.appendChild(it);
  });
  box.querySelectorAll("[data-say]").forEach(b=> b.onclick=()=> speak(b.dataset.say,"de-DE"));
  box.querySelectorAll("[data-rem]").forEach(b=> b.onclick=()=>{
    const id=b.dataset.rem; state.flash.favorites=state.flash.favorites.filter(x=>x.id!==id);
    localStorage.setItem("fav-cards", JSON.stringify(state.flash.favorites)); renderFavorites();
  });
}

/* ========= –ì–†–ê–ú–ú–ê–¢–ò–ö–ê ========= */
function buildGrammar(){
  const sel=$("#gramTopic"); sel.innerHTML="";
  topicKeys.forEach(k=>{
    topics[k].grammar?.forEach((g,i)=>{
      const o=document.createElement("option");
      o.value=`${k}|${i}`;
      o.textContent=`${topics[k].name[lang]||topics[k].name.ru} ‚Äî ${g.title[lang]||g.title.ru}`;
      sel.appendChild(o);
    })
  });
  sel.onchange=renderGrammar;
  if(sel.options.length) sel.selectedIndex=0;
  renderGrammar();
}
function renderGrammar(){
  const val=$("#gramTopic").value;
  if(!val){ $("#grammarBody").innerHTML="<p class='small'>–î–æ–±–∞–≤—å—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏.</p>"; return; }
  const [tk,idx]=val.split("|");
  const g=topics[tk].grammar[idx];
  $("#grammarBody").innerHTML = g.html[lang]||g.html.ru;
}

/* ========= –î–ò–ê–õ–û–ì–ò ========= */
function buildDialogs(){
  const sel=$("#dlgTopic"); sel.innerHTML="";
  topicKeys.forEach(k=>{
    const o=document.createElement("option");
    o.value=k; o.textContent=topics[k].name[lang]||topics[k].name.ru;
    sel.appendChild(o);
  });
  sel.onchange=renderDialogs;
  renderDialogs();
}
function renderDialogs(){
  const tk=$("#dlgTopic").value || topicKeys[0];
  const body=$("#dialogsList"); body.innerHTML="";
  (topics[tk].dialogs||[]).forEach(d=>{
    const div=document.createElement("div"); div.className="dialog-item";
    div.innerHTML=`<div class="title">${d.title[lang]||d.title.ru}</div>
      <ul style="margin:8px 0 0;padding-left:18px">
        ${d.lines.map(l=>`<li><b>${l.role}:</b> ${l.de} <span class="small">‚Äî ${(l[lang]||l.ru)}</span></li>`).join("")}
      </ul>`;
    body.appendChild(div);
  });
}
$("#playDlg").onclick=()=>{
  const tk=$("#dlgTopic").value || topicKeys[0];
  const d=(topics[tk].dialogs||[])[0];
  if(!d) return;
  const seq = d.lines.map(l=>l.de).join(". ");
  speak(seq,"de-DE");
}

/* ========= –û–ó–í–£–ß–ö–ê ========= */
function speak(text, locale="de-DE"){
  if(!("speechSynthesis" in window)) return alert("–û–∑–≤—É—á–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º");
  const u=new SpeechSynthesisUtterance(text);
  u.lang=locale; u.rate=1; u.pitch=1;
  window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
}
$("#speakBtn").onclick=()=> speak(UI[lang].voiceHint, lang==="de"?"de-DE": lang==="az"?"az-AZ":"ru-RU");

/* ========= –ú–ï–õ–û–ß–ò ========= */
$("#flashcard").addEventListener("click", flip);
$("#flashcard").addEventListener("keydown", e=>{ if(e.key===" "||e.key==="Enter") flip(); });
$("#year").textContent = new Date().getFullYear();

/* init */
applyUI();
</script>
</body>
</html>
