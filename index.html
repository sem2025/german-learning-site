<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Deutsch Lernen ‚Äî Trilingual</title>
<meta name="theme-color" content="#0ea5e9">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='1' y2='0'%3E%3Cstop stop-color='%230f172a'/%3E%3Cstop stop-color='%230ea5e9' offset='.9'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='22' fill='url(%23g)'/%3E%3Ctext x='50' y='60' font-size='44' text-anchor='middle' fill='white' font-family='Inter, Arial, sans-serif'%3EDE%3C/text%3E%3C/svg%3E">
<style>
:root{
  --primary:#0ea5e9; --primary-dark:#0284c7;
  --bg:#0b1020; --surface:#0f172a; --card:#101827;
  --text:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee;
  --ok:#22c55e; --warn:#f59e0b; --r:16px;
  --shadow:0 10px 30px rgba(0,0,0,.25)
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text); background:radial-gradient(1200px 800px at 10% -10%, #0b3a5a33, transparent 60%), linear-gradient(180deg,#0b1020 0,#0b1020 260px,#0b1325 100%)
}
.container{max-width:1100px;padding:18px;margin:0 auto}
.header{
  position:sticky;top:0;z-index:50;backdrop-filter: blur(6px);
  background:linear-gradient(180deg,#08111fdd,#08111f88 70%,transparent);
  border-bottom: 1px solid #1e293b;
}
.brand{
  display:flex;align-items:center;gap:12px;padding:14px 6px 8px
}
.brand h1{margin:0;font-weight:800;letter-spacing:.3px}
.logo{
  width:46px;height:46px;border-radius:50%;
  background:linear-gradient(135deg,var(--primary),#38bdf8 70%);
  box-shadow:0 4px 16px #0ea5e944; display:grid;place-items:center;color:white;font-weight:800
}
.lang-switch, .nav{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center
}
.btn, .chip {
  border:1px solid #1f2a44;background:#0e162d;color:var(--text);
  padding:8px 12px;border-radius:999px;cursor:pointer;
  transition:.2s box-shadow,.2s background,.2s transform;font-weight:600;
  display:inline-flex;align-items:center;gap:6px;
}
.btn:focus, .chip:focus {
  outline: 2px solid var(--primary); 
  box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--primary);
}
.btn.active, .nav button.active{background:var(--primary);border-color:var(--primary);color:white;box-shadow:0 6px 20px #0ea5e944}
.lang-switch{margin-left:auto}
.header-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.nav{
  padding:8px 0;
  border-bottom: 1px solid #1e293b;
  margin: 0 -16px;
}
.nav button {
  padding: 8px 16px;
  border: none;
  background: transparent;
  font-weight: 600;
}
.search{display:flex;gap:10px;align-items:center;margin:10px 0 0}
.search input{
  width:min(520px,100%); padding:12px 14px;border-radius:14px;border:1px solid #1f2a44;background:#0e162d;color:var(--text);
  transition: border-color .2s;
}
.search input:focus {
  border-color: var(--primary);
  outline: none;
}
.btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
.btn.ghost{background:transparent}
.grid{
  display:grid;grid-template-columns:repeat(12,1fr); gap:16px;margin-top:14px
}
.card{
  grid-column:span 12;background:linear-gradient(180deg,#0f1a33,#0e162d);
  border:1px solid #1f2a44;border-radius:20px;padding:16px;box-shadow:var(--shadow)
}
.card h3{margin:0 0 10px}
.badge{display:inline-flex;gap:8px;align-items:center;background:#0a162e;border:1px solid #1f2a44;color:#9ecff8;padding:6px 10px;border-radius:12px;font-size:.88rem}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.lesson, .dict-item, .dialog-item{
  border:1px solid #1f2a44;border-radius:16px;padding:12px 14px;background:#0d1730;
  transition: transform .15s, border-color .15s;
}
.lesson:hover, .dict-item:hover, .dialog-item:hover {
  border-color: var(--primary);
  transform: translateY(-2px);
}
.lesson{display:flex;gap:12px;align-items:flex-start}
.lesson .title{font-weight:700}
.kicker{color:var(--muted);font-size:.86rem}
.dict-head{display:flex;gap:8px;align-items:center;justify-content:space-between}
.dict-body{display:grid;grid-template-columns:repeat(1, minmax(0,1fr)); gap:10px;margin-top:10px}
.tag{padding:4px 8px;border:1px solid #1f2a44;background:#0b1a31;border-radius:999px;color:#a5b4fc;font-size:.8rem}
.favorite{cursor:pointer; transition: color .2s; }
.favorite:hover { color: var(--warn); }
hr.sep{border:0;border-top:1px dashed #203050;margin:14px 0}
.flashcard{
  height:190px;border-radius:18px;background:linear-gradient(160deg,#0e3c60,#0b2744 60%);
  color:#e8f5ff;display:grid;place-items:center;font-size:1.2rem;font-weight:700;
  border:1px solid #1e3a5f;box-shadow:var(--shadow); user-select:none; text-align:center;padding:16px;
  cursor: pointer;
  transition: all .3s ease;
}
.flashcard:hover {
  transform: scale(1.02);
  box-shadow: 0 12px 30px rgba(0,0,0,.3);
}
.controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:12px;flex-wrap:wrap}
select, .select{
  padding:10px 12px;border-radius:12px;border:1px solid #1f2a44;background:#0e162d;color:var(--text);
  appearance: none;
  background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 32px;
}
.small{font-size:.86rem;color:var(--muted)}
.right{margin-left:auto}
footer{opacity:.8;margin:40px 0 30px;text-align:center;font-size:.9rem;color:#9fb6d1}
footer a { color: var(--primary); text-decoration: none; }
footer a:hover { text-decoration: underline; }

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ç–∞–±—ã */
[role="tablist"] {
  position: relative;
}
[role="tablist"]::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 2px;
  background: #1e293b;
}
.tab-indicator {
  position: absolute;
  bottom: 0;
  height: 2px;
  background: var(--primary);
  transition: transform .3s cubic-bezier(0.645, 0.045, 0.355, 1);
  will-change: transform;
}

@media (min-width:700px){
  .card.span-6{grid-column:span 6}
  .card.span-4{grid-column:span 4}
  .dict-body{grid-template-columns:repeat(2, minmax(0,1fr))}
}
@media (min-width:980px){
  .dict-body{grid-template-columns:repeat(3, minmax(0,1fr))}
}
</style>
</head>
<body>
<header class="header" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
  <div class="container">
    <div class="header-row">
      <div class="brand">
        <div class="logo" aria-hidden="true">DE</div>
        <h1 id="appTitle">Deutsch Lernen</h1>
        <span class="badge" id="badgeTag">–¢—Ä–∏ —è–∑—ã–∫–∞</span>
      </div>
      <div class="lang-switch" role="tablist" aria-label="–Ø–∑—ã–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞">
        <button data-lang="ru" class="active" role="tab" aria-selected="true" aria-controls="tab-ru">RU</button>
        <button data-lang="de" role="tab" aria-selected="false" aria-controls="tab-de">DE</button>
        <button data-lang="az" role="tab" aria-selected="false" aria-controls="tab-az">AZ</button>
      </div>
    </div>

    <div class="row">
      <nav class="nav" id="navTabs" role="tablist" aria-label="–†–∞–∑–¥–µ–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è">
        <button data-tab="lessons" class="active" role="tab" aria-selected="true" aria-controls="view-lessons">–£—Ä–æ–∫–∏</button>
        <button data-tab="dictionary" role="tab" aria-selected="false" aria-controls="view-dictionary">–°–ª–æ–≤–∞—Ä—å</button>
        <button data-tab="flashcards" role="tab" aria-selected="false" aria-controls="view-flashcards">–ö–∞—Ä—Ç–æ—á–∫–∏</button>
        <button data-tab="grammar" role="tab" aria-selected="false" aria-controls="view-grammar">–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞</button>
        <button data-tab="dialogs" role="tab" aria-selected="false" aria-controls="view-dialogs">–î–∏–∞–ª–æ–≥–∏</button>
        <span class="tab-indicator" id="tabIndicator"></span>
      </nav>
      <div class="search right">
        <input id="searchInput" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤–∞—Ä—é‚Ä¶" aria-label="–ü–æ–∏—Å–∫ –≤ —Å–ª–æ–≤–∞—Ä–µ" />
        <button class="btn" id="speakBtn" title="–û–∑–≤—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É" aria-label="–û–∑–≤—É—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è">üîä</button>
      </div>
    </div>
  </div>
</header>

<main class="container" id="views">
  <!-- LESSONS -->
  <section id="view-lessons" class="grid" role="tabpanel" aria-labelledby="tab-lessons">
    <div class="card span-6">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 data-i="l_greetings">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ</h3>
        <span class="kicker" id="lessCount">5 —É—Ä–æ–∫(–æ–≤)</span>
      </div>
      <div id="lessonsList" class="lessons-container"></div>
    </div>

    <div class="card span-6">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 data-i="l_basics">–û—Å–Ω–æ–≤—ã</h3>
        <span class="kicker" id="progStat">0% ‚Ä¢ 0/0</span>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <span class="chip">Alphabet ‚Ä¢ A1</span>
        <span class="chip">Numbers ‚Ä¢ A1</span>
        <span class="chip">Days & Time ‚Ä¢ A1</span>
        <span class="chip">Cases intro ‚Ä¢ A2</span>
      </div>
      <hr class="sep">
      <div class="row">
        <button class="btn primary" id="startQuick">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</button>
        <button class="btn ghost" id="resetProgress">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        <span class="small right" id="saveHint">–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ</span>
      </div>
    </div>
  </section>

  <!-- DICTIONARY -->
  <section id="view-dictionary" class="grid" hidden role="tabpanel" aria-labelledby="tab-dictionary">
    <div class="card">
      <div class="dict-head">
        <h3 data-i="d_title">–°–ª–æ–≤–∞—Ä—å</h3>
        <div class="row">
          <label for="dictTopic" class="small" aria-hidden="true">–¢–µ–º–∞:</label>
          <select id="dictTopic" aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É —Å–ª–æ–≤–∞—Ä—è"></select>
          <button class="btn" id="exportCSV" aria-label="–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV">CSV</button>
        </div>
      </div>
      <div class="dict-body" id="dictBody"></div>
    </div>
  </section>

  <!-- FLASHCARDS -->
  <section id="view-flashcards" class="grid" hidden role="tabpanel" aria-labelledby="tab-flashcards">
    <div class="card span-6">
      <div class="row" style="justify-content:space-between">
        <h3 data-i="f_title">–ö–∞—Ä—Ç–æ—á–∫–∏</h3>
        <div class="row">
          <label class="small" for="fcTopic" data-i="topic" aria-hidden="true">–¢–µ–º–∞</label>
          <select id="fcTopic" aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∫–∞—Ä—Ç–æ—á–µ–∫"></select>
        </div>
      </div>
      <div class="flashcard" id="flashcard" tabindex="0" aria-live="polite" aria-label="–ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è">‚Äî</div>
      <div class="controls">
        <button class="btn" id="prevCard" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞">‚óÄ</button>
        <span id="fcPos" class="small" aria-live="polite">0/0</span>
        <button class="btn" id="nextCard" aria-label="–°–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞">‚ñ∂</button>
        <button class="btn" id="flipCard" data-i="flip" aria-label="–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É">–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</button>
        <button class="btn" id="ttsCard" aria-label="–û–∑–≤—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É">üîä</button>
        <button class="btn" id="favCard" aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">‚òÖ</button>
        <button class="btn" id="shuffleCard" aria-label="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏">üîÄ</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="small" for="fcSide">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å:</label>
        <select id="fcSide" aria-label="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞">
          <option value="front">DE ‚Üí (RU/AZ)</option>
          <option value="back">(RU/AZ) ‚Üí DE</option>
          <option value="mix">–°–º–µ—à–∞—Ç—å</option>
        </select>
      </div>
    </div>

    <div class="card span-6">
      <h3 data-i="fav">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h3>
      <div id="favorites" class="dict-body"></div>
    </div>
  </section>

  <!-- GRAMMAR -->
  <section id="view-grammar" class="grid" hidden role="tabpanel" aria-labelledby="tab-grammar">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 data-i="g_title">–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞</h3>
        <div class="row">
          <label for="gramTopic" class="small" aria-hidden="true">–¢–µ–º–∞:</label>
          <select id="gramTopic" aria-label="–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ç–µ–º—É"></select>
        </div>
      </div>
      <article id="grammarBody" class="grammar-content"></article>
    </div>
  </section>

  <!-- DIALOGS -->
  <section id="view-dialogs" class="grid" hidden role="tabpanel" aria-labelledby="tab-dialogs">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 data-i="dlg_title">–î–∏–∞–ª–æ–≥–∏</h3>
        <div class="row">
          <label for="dlgTopic" class="small" aria-hidden="true">–¢–µ–º–∞:</label>
          <select id="dlgTopic" aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–∏–∞–ª–æ–≥–∞"></select>
          <button class="btn" id="playDlg" aria-label="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥">‚ñ∂</button>
        </div>
      </div>
      <div id="dialogsList" class="dict-body"></div>
    </div>
  </section>
</main>

<footer>
  ¬© <span id="year"></span> Deutsch Lernen ‚Ä¢ <span id="footLang">–†—É—Å—Å–∫–∏–π</span> / Deutsch / Az…ôrbaycan. 
  <span class="small">–û—Ñ—Ñ–ª–∞–π–Ω-—Ä–∞–±–æ—Ç–∞: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</span>
  <div class="small" style="margin-top: 8px;">
    <a href="#" id="accessibilityToggle" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏</a>
  </div>
</footer>

<script>
/* ========= –ú–£–õ–¨–¢–ò–Ø–ó–´–ß–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° ========= */
const UI = {
  ru:{
    title:"Deutsch Lernen", tag:"–¢—Ä–∏ —è–∑—ã–∫–∞",
    tabs:{lessons:"–£—Ä–æ–∫–∏", dictionary:"–°–ª–æ–≤–∞—Ä—å", flashcards:"–ö–∞—Ä—Ç–æ—á–∫–∏", grammar:"–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", dialogs:"–î–∏–∞–ª–æ–≥–∏"},
    l_greetings:"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ", l_basics:"–û—Å–Ω–æ–≤—ã",
    d_title:"–°–ª–æ–≤–∞—Ä—å", f_title:"–ö–∞—Ä—Ç–æ—á–∫–∏", topic:"–¢–µ–º–∞", flip:"–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å", fav:"–ò–∑–±—Ä–∞–Ω–Ω–æ–µ",
    g_title:"–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞", dlg_title:"–î–∏–∞–ª–æ–≥–∏",
    placeholders:{search:"–ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤–∞—Ä—é‚Ä¶"},
    voiceHint:"–°–∫–∞–∂–∏: ¬´–û–∑–≤—É—á—å —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É¬ª",
    foot:"–†—É—Å—Å–∫–∏–π",
    resetConfirm: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è?",
    noData: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",
    exportSuccess: "–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ",
    exportError: "–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ"
  },
  de:{
    title:"Deutsch Lernen", tag:"Dreisprachig",
    tabs:{lessons:"Lektionen", dictionary:"W√∂rterbuch", flashcards:"Karten", grammar:"Grammatik", dialogs:"Dialoge"},
    l_greetings:"Begr√º√üung & Kennenlernen", l_basics:"Grundlagen",
    d_title:"W√∂rterbuch", f_title:"Karten", topic:"Thema", flip:"Umdrehen", fav:"Favoriten",
    g_title:"Grammatik", dlg_title:"Dialoge",
    placeholders:{search:"Im W√∂rterbuch suchen‚Ä¶"},
    voiceHint:"Sag: ‚ÄûLies die aktuelle Karte vor‚Äú",
    foot:"Deutsch",
    resetConfirm: "M√∂chten Sie wirklich Ihren gesamten Lernfortschritt zur√ºcksetzen?",
    noData: "Keine Daten zum Anzeigen",
    exportSuccess: "Export erfolgreich abgeschlossen",
    exportError: "Daten konnten nicht exportiert werden"
  },
  az:{
    title:"Deutsch Lernen", tag:"√ú√ß dilli",
    tabs:{lessons:"D…ôrsl…ôr", dictionary:"L√ºƒü…ôt", flashcards:"Kartlar", grammar:"Qrammatika", dialogs:"Dialoqlar"},
    l_greetings:"Salamla≈üma v…ô tanƒ±≈ülƒ±q", l_basics:"∆èsaslar",
    d_title:"L√ºƒü…ôt", f_title:"Kartlar", topic:"M√∂vzu", flip:"√áevir", fav:"Se√ßilmi≈ül…ôr",
    g_title:"Qrammatika", dlg_title:"Dialoqlar",
    placeholders:{search:"L√ºƒü…ôtd…ô axtarƒ±≈ü‚Ä¶"},
    voiceHint:"De: ‚ÄúKartƒ± s…ôsl…ôndir‚Äù",
    foot:"Az…ôrbaycan",
    resetConfirm: "√ñyr…ônm…ô t…ôr…ôqqinizi sƒ±fƒ±rlamaq ist…ôdiyiniz…ô …ôminsiniz?",
    noData: "G√∂st…ôrilm…ôk √º√ß√ºn m…ôlumat yoxdur",
    exportSuccess: "Eksport uƒüurla ba≈üa √ßatdƒ±",
    exportError: "M…ôlumatlarƒ± eksport etm…ôk m√ºmk√ºn olmadƒ±"
  }
};
let lang = localStorage.getItem("ui-lang") || "ru";
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

/* ========= –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ========= */
function escapeHTML(str) {
  if (!str) return '';
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '<')
    .replace(/>/g, '>')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

/* ========= –î–ê–ù–ù–´–ï ========= */
const topics = {
  greetings:{
    name:{ru:"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è", de:"Begr√º√üung", az:"Salamla≈üma"},
    words:[
      {de:"Guten Morgen!", ru:"–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!", az:"Sabahƒ±nƒ±z xeyir!"},
      {de:"Guten Tag!", ru:"–î–æ–±—Ä—ã–π –¥–µ–Ω—å!", az:"G√ºnortanƒ±z xeyir!"},
      {de:"Guten Abend!", ru:"–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!", az:"Ax≈üamƒ±nƒ±z xeyir!"},
      {de:"Wie geht's?", ru:"–ö–∞–∫ –¥–µ–ª–∞?", az:"Nec…ôs…ôn?"},
      {de:"Danke, gut.", ru:"–°–ø–∞—Å–∏–±–æ, —Ö–æ—Ä–æ—à–æ.", az:"Saƒü ol, yax≈üƒ±."},
      {de:"Ich hei√üe ‚Ä¶", ru:"–ú–µ–Ω—è –∑–æ–≤—É—Ç ‚Ä¶", az:"M…ônim adƒ±m ‚Ä¶"}
    ],
    dialogs:[
      {title:{ru:"–ü–µ—Ä–≤–æ–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ",de:"Erstes Kennenlernen",az:"ƒ∞lk tanƒ±≈ülƒ±q"},
       lines:[
        {role:"A", de:"Hallo! Ich hei√üe Aylin. Wie hei√üt du?", ru:"–ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–π–ª–∏–Ω. –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?", az:"Salam! M…ônim adƒ±m Aylindir. S…ônin adƒ±n n…ôdir?"},
        {role:"B", de:"Ich hei√üe Samir. Freut mich!", ru:"–ú–µ–Ω—è –∑–æ–≤—É—Ç –°–∞–º–∏—Ä. –ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è!", az:"M…ônim adƒ±m Samirdir. Tanƒ±≈ü olduƒüuma ≈üadam!"},
        {role:"A", de:"Wie geht‚Äôs dir?", ru:"–ö–∞–∫ –¥–µ–ª–∞?", az:"Nec…ôs…ôn?"},
        {role:"B", de:"Danke, gut. Und dir?", ru:"–°–ø–∞—Å–∏–±–æ, —Ö–æ—Ä–æ—à–æ. –ê —É —Ç–µ–±—è?", az:"Saƒü ol, yax≈üƒ±. S…ônd…ô nec…ô?"}
       ]
      }
    ],
    grammar:[
      {title:{ru:"–ü—Ä–µ–¥–∏–∫–∞—Ç–∏–≤ sein: ich bin ‚Ä¶", de:"Pr√§dikativ mit sein", az:"‚ÄòSein‚Äô felinin istifad…ôsi"},
       html:{
        ru:`<p><b>sein</b> ‚Äî –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≥–ª–∞–≥–æ–ª '–±—ã—Ç—å'. –§–æ—Ä–º—ã: <code>ich bin, du bist, er/sie/es ist, wir sind, ihr seid, sie/Sie sind</code>.</p>
            <ul><li>Ich <b>bin</b> Samir.</li><li>Du <b>bist</b> Aylin.</li></ul>`,
        de:`<p><b>sein</b> (ich bin, du bist, er/sie/es ist ‚Ä¶). Beispiele: Ich <b>bin</b> Samir. Du <b>bist</b> Aylin.</p>`,
        az:`<p><b>sein</b> feilinin formalarƒ±: <code>ich bin, du bist, er/sie/es ist ‚Ä¶</code>. Misal: M…ôn <b>Samir…ôm</b>.</p>`
       }}
    ],
    lessons:[
      {title:{ru:"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?",de:"Hallo! Wie hei√üen Sie?",az:"Salam! Adƒ±nƒ±z n…ôdir?"},
       points:[
        {de:"Ich hei√üe Samir.", ru:"–ú–µ–Ω—è –∑–æ–≤—É—Ç –°–∞–º–∏—Ä.", az:"M…ônim adƒ±m Samirdir."},
        {de:"Wie geht's?", ru:"–ö–∞–∫ –¥–µ–ª–∞?", az:"Nec…ôs…ôn?"},
        {de:"Freut mich!", ru:"–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è!", az:"Tanƒ±≈ü olduƒüuma ≈üadam!"}
       ]},
      {title:{ru:"–ö–∞–∫ –¥–µ–ª–∞?",de:"Wie geht's?",az:"Nec…ôs…ôn?"},
       points:[
        {de:"Danke, gut.", ru:"–°–ø–∞—Å–∏–±–æ, —Ö–æ—Ä–æ—à–æ.", az:"Saƒü ol, yax≈üƒ±."},
        {de:"Und dir?", ru:"–ê —É —Ç–µ–±—è?", az:"B…ôs s…ôn?"}
       ]}
    ]
  },
  work:{
    name:{ru:"–†–∞–±–æ—Ç–∞", de:"Arbeit", az:"ƒ∞≈ü"},
    words:[
      {de:"der Beruf", ru:"–ø—Ä–æ—Ñ–µ—Å—Å–∏—è", az:"pe≈ü…ô"},
      {de:"die Arbeit", ru:"—Ä–∞–±–æ—Ç–∞", az:"i≈ü"},
      {de:"der Kollege", ru:"–∫–æ–ª–ª–µ–≥–∞ (–º.)", az:"h…ômkar (ki≈üi)"},
      {de:"die Kollegin", ru:"–∫–æ–ª–ª–µ–≥–∞ (–∂.)", az:"h…ômkar (qadƒ±n)"},
      {de:"das B√ºro", ru:"–æ—Ñ–∏—Å", az:"ofis"},
      {de:"die Aufgabe", ru:"–∑–∞–¥–∞—á–∞", az:"tap≈üƒ±rƒ±q"}
    ],
    dialogs:[
      {title:{ru:"–ù–∞ –Ω–æ–≤–æ–π —Ä–∞–±–æ—Ç–µ",de:"Im neuen Job",az:"Yeni i≈üd…ô"},
       lines:[
        {role:"A", de:"Wo arbeitest du?", ru:"–ì–¥–µ —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å?", az:"Harada i≈ül…ôyirs…ôn?"},
        {role:"B", de:"Ich arbeite im B√ºro als Verk√§ufer.", ru:"–Ø —Ä–∞–±–æ—Ç–∞—é –≤ –æ—Ñ–∏—Å–µ –ø—Ä–æ–¥–∞–≤—Ü–æ–º.", az:"M…ôn ofisd…ô satƒ±cƒ± kimi i≈ül…ôyir…ôm."}
       ]}
    ],
    grammar:[
      {title:{ru:"–ì–ª–∞–≥–æ–ª—ã —Å –ª–∏—á–Ω—ã–º–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è–º–∏",de:"Personalendungen",az:"≈û…ôxs sonluqlarƒ±"},
       html:{
        ru:`<p>–û–±—ã—á–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã –≤ Pr√§sens: <code>ich -e, du -st, er/sie/es -t, wir -en, ihr -t, sie/Sie -en</code>.</p>`,
        de:`<p>Pr√§sens-Endungen: <code>-e, -st, -t, -en, -t, -en</code>.</p>`,
        az:`<p>ƒ∞ndiki zamanda feil sonluqlarƒ±: <code>-e, -st, -t, -en, -t, -en</code>.</p>`
       }}
    ],
    lessons:[
      {title:{ru:"–†–∞—Å—Å–∫–∞–∑ –æ —Ä–∞–±–æ—Ç–µ",de:"√úber die Arbeit erz√§hlen",az:"ƒ∞≈ü haqqƒ±nda danƒ±≈ü"},
       points:[
        {de:"Ich arbeite als Fahrer.", ru:"–Ø —Ä–∞–±–æ—Ç–∞—é –≤–æ–¥–∏—Ç–µ–ª–µ–º.", az:"M…ôn s√ºr√ºc√º i≈ül…ôyir…ôm."},
        {de:"Meine Aufgaben sind ‚Ä¶", ru:"–ú–æ–∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ ‚Ä¶", az:"M…ônim v…ôzif…ôl…ôrim ‚Ä¶"}
       ]}
    ]
  }
};
const topicKeys = Object.keys(topics);

/* ========= –°–û–°–¢–û–Ø–ù–ò–ï ========= */
const state = {
  tab: "lessons",
  ui: UI[lang],
  flash: {
    topic: topicKeys[0],
    idx: 0, 
    side: "front", 
    order: [],
    favorites: JSON.parse(localStorage.getItem("fav-cards") || "[]")
  },
  progress: JSON.parse(localStorage.getItem("progress") || "{}")
};

/* ========= –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –Ø–ó–´–ö–ê UI ========= */
function applyUI() {
  document.documentElement.lang = lang;
  state.ui = UI[lang];
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —É–∑–ª—ã –±–µ–∑ –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏—è DOM
  $("#appTitle").textContent = state.ui.title;
  $("#badgeTag").textContent = state.ui.tag;
  $("#searchInput").placeholder = state.ui.placeholders.search;
  $("#footLang").textContent = state.ui.foot;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
  document.querySelectorAll("[data-i]").forEach(el => {
    const key = el.dataset.i;
    if (state.ui[key]) {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        el.placeholder = state.ui[key];
      } else {
        el.textContent = state.ui[key];
      }
    }
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
  $$("#navTabs button").forEach(btn => {
    const tabName = btn.dataset.tab;
    if (state.ui.tabs[tabName]) {
      btn.textContent = state.ui.tabs[tabName];
    }
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  updateTabIndicator();
  
  // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–¥–µ–ª
  if (state.tab === "lessons") buildLessons();
  if (state.tab === "dictionary") buildDictionary();
  if (state.tab === "flashcards") buildFlashcards();
  if (state.tab === "grammar") buildGrammar();
  if (state.tab === "dialogs") buildDialogs();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
function updateTabIndicator() {
  const activeTab = $("#navTabs .active");
  if (!activeTab) return;
  
  const indicator = $("#tabIndicator");
  indicator.style.width = `${activeTab.offsetWidth}px`;
  indicator.style.transform = `translateX(${activeTab.offsetLeft}px)`;
}

/* ========= –ù–ê–í–ò–ì–ê–¶–ò–Ø ========= */
function setupNavigation() {
  // –Ø–∑—ã–∫–æ–≤—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏
  document.querySelectorAll(".lang-switch button").forEach(btn => {
    btn.addEventListener("click", () => {
      if (btn.classList.contains("active")) return;
      
      document.querySelectorAll(".lang-switch button").forEach(b => {
        b.classList.remove("active");
        b.setAttribute("aria-selected", "false");
      });
      
      btn.classList.add("active");
      btn.setAttribute("aria-selected", "true");
      lang = btn.dataset.lang;
      localStorage.setItem("ui-lang", lang);
      applyUI();
    });
  });

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤
  document.querySelectorAll("#navTabs button").forEach(btn => {
    btn.addEventListener("click", () => {
      if (btn.classList.contains("active")) return;
      
      const tab = btn.dataset.tab;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      state.tab = tab;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      document.querySelectorAll("#navTabs button").forEach(b => {
        b.classList.toggle("active", b === btn);
        b.setAttribute("aria-selected", b === btn ? "true" : "false");
      });
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª
      ["lessons", "dictionary", "flashcards", "grammar", "dialogs"].forEach(id => {
        $(`#view-${id}`).hidden = id !== tab;
      });
      
      updateTabIndicator();
      
      // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–¥–µ–ª
      if (tab === "lessons") buildLessons();
      if (tab === "dictionary") buildDictionary();
      if (tab === "flashcards") buildFlashcards();
      if (tab === "grammar") buildGrammar();
      if (tab === "dialogs") buildDialogs();
    });
  });
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
  updateTabIndicator();
  window.addEventListener('resize', updateTabIndicator);
}

/* ========= –£–†–û–ö–ò ========= */
function buildLessons() {
  const wrap = $("#lessonsList");
  wrap.innerHTML = "";
  
  const allLessons = [];
  topicKeys.forEach(tk => {
    topics[tk].lessons?.forEach(ls => allLessons.push({ tk, ls }));
  });
  
  $("#lessCount").textContent = `${allLessons.length} ${getLessonCountText(allLessons.length)}`;
  
  if (allLessons.length === 0) {
    wrap.innerHTML = `<div class="lesson" style="opacity:0.7">${state.ui.noData}</div>`;
    return;
  }
  
  allLessons.forEach(({ tk, ls }, index) => {
    const isCompleted = state.progress[tk]?.[ls.title.de];
    const progressIcon = isCompleted ? "‚úÖ" : "‚≠ï";
    
    const el = document.createElement("div");
    el.className = "lesson";
    el.dataset.lessonKey = tk;
    el.dataset.lessonTitle = ls.title.de;
    
    el.innerHTML = `
      <div style="font-size:24px" aria-hidden="true">${progressIcon}</div>
      <div>
        <div class="kicker">${escapeHTML(topics[tk].name[lang] || topics[tk].name.ru)}</div>
        <div class="title">${escapeHTML(ls.title[lang] || ls.title.ru)}</div>
        <ul style="margin:8px 0 0;padding-left:18px">
          ${ls.points.map(p => `
            <li>
              <span class="de">${escapeHTML(p.de)}</span> 
              ‚Äî 
              <span class="small">${escapeHTML(p[lang] || p.ru)}</span>
            </li>
          `).join("")}
        </ul>
        <div class="row" style="margin-top:8px;gap:8px">
          <button class="btn primary" data-action="complete-lesson">
            ${isCompleted ? "–ü–µ—Ä–µ–π—Ç–∏" : "–û—Ç–º–µ—Ç–∏—Ç—å"}
          </button>
          <button class="btn" data-action="speak-lesson">
            <span aria-hidden="true">üîä</span>
            <span class="sr-only">–û–∑–≤—É—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä</span>
          </button>
        </div>
      </div>`;
    
    wrap.appendChild(el);
  });
  
  // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —É—Ä–æ–∫–æ–≤
  wrap.addEventListener("click", handleLessonsClick);
  updateProgStat();
}

function handleLessonsClick(e) {
  const button = e.target.closest("button");
  if (!button) return;
  
  const lessonEl = button.closest(".lesson");
  const tk = lessonEl.dataset.lessonKey;
  const title = lessonEl.dataset.lessonTitle;
  
  if (button.dataset.action === "complete-lesson") {
    toggleLessonCompletion(tk, title);
  } 
  else if (button.dataset.action === "speak-lesson") {
    const deText = lessonEl.querySelector(".de").textContent;
    speak(deText, "de-DE");
  }
}

function toggleLessonCompletion(tk, title) {
  state.progress[tk] = state.progress[tk] || {};
  state.progress[tk][title] = !state.progress[tk][title];
  localStorage.setItem("progress", JSON.stringify(state.progress));
  buildLessons();
  updateProgStat();
}

function getLessonCountText(count) {
  if (count % 10 === 1 && count % 100 !== 11) return "—É—Ä–æ–∫";
  if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) return "—É—Ä–æ–∫–∞";
  return "—É—Ä–æ–∫–æ–≤";
}

function updateProgStat() {
  const all = [];
  const done = [];
  
  topicKeys.forEach(tk => {
    topics[tk].lessons?.forEach(ls => {
      all.push(ls.title.de);
      if (state.progress[tk]?.[ls.title.de]) done.push(ls.title.de);
    });
  });
  
  const pct = all.length ? Math.round(done.length / all.length * 100) : 0;
  $("#progStat").textContent = `${pct}% ‚Ä¢ ${done.length}/${all.length}`;
}

$("#startQuick").addEventListener("click", () => {
  state.tab = "flashcards";
  document.querySelectorAll("#navTabs button[data-tab='flashcards']")[0].click();
});

$("#resetProgress").addEventListener("click", () => {
  if (confirm(state.ui.resetConfirm)) {
    localStorage.removeItem("progress");
    state.progress = {};
    buildLessons();
  }
});

/* ========= –°–õ–û–í–ê–†–¨ ========= */
function buildDictionary() {
  const sel = $("#dictTopic");
  sel.innerHTML = "";
  
  topicKeys.forEach(k => {
    const option = document.createElement("option");
    option.value = k;
    option.textContent = escapeHTML(topics[k].name[lang] || topics[k].name.ru);
    sel.appendChild(option);
  });
  
  if (sel.options.length > 0) {
    sel.value = state.flash.topic || sel.options[0].value;
  } else {
    sel.innerHTML = `<option value="">${state.ui.noData}</option>`;
    $("#dictBody").innerHTML = `<div class="dict-item">${state.ui.noData}</div>`;
    return;
  }
  
  renderDict(sel.value);
  sel.addEventListener("change", () => renderDict(sel.value));
  
  const searchInput = $("#searchInput");
  searchInput.value = "";
  searchInput.addEventListener("input", () => renderDict(sel.value, searchInput.value.trim()));
  
  $("#exportCSV").addEventListener("click", () => exportCSV(sel.value));
}

function renderDict(tk, query = "") {
  const box = $("#dictBody");
  box.innerHTML = "";
  
  if (!topics[tk] || !topics[tk].words) {
    box.innerHTML = `<div class="dict-item">${state.ui.noData}</div>`;
    return;
  }
  
  const data = topics[tk].words.filter(w => {
    if (!query) return true;
    const q = query.toLowerCase();
    return w.de.toLowerCase().includes(q) || 
           (w[lang] || w.ru).toLowerCase().includes(q);
  });
  
  if (data.length === 0) {
    box.innerHTML = `<div class="dict-item">${state.ui.noData}</div>`;
    return;
  }
  
  data.forEach(w => {
    const favId = `${w.de}|${w.ru}`;
    const isFav = state.flash.favorites.some(x => x.id === favId);
    
    const item = document.createElement("div");
    item.className = "dict-item";
    item.innerHTML = `
      <div class="row" style="justify-content:space-between;gap:12px">
        <div>
          <b>${escapeHTML(w.de)}</b>
          <div class="small">${escapeHTML(w[lang] || w.ru)}</div>
        </div>
        <div class="row">
          <button class="btn" aria-label="–û–∑–≤—É—á–∏—Ç—å —Å–ª–æ–≤–æ" data-action="speak-word" data-word="${escapeHTML(w.de)}">
            <span aria-hidden="true">üîä</span>
          </button>
          <button class="btn favorite" aria-label="${isFav ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}" 
                  data-action="toggle-favorite" data-word='${JSON.stringify({...w, id: favId})}'>
            ${isFav ? "‚òÖ" : "‚òÜ"}
          </button>
        </div>
      </div>`;
    
    box.appendChild(item);
  });
}

/* ========= –ö–ê–†–¢–û–ß–ö–ò ========= */
function buildFlashcards() {
  const sel = $("#fcTopic");
  sel.innerHTML = "";
  
  topicKeys.forEach(k => {
    const option = document.createElement("option");
    option.value = k;
    option.textContent = escapeHTML(topics[k].name[lang] || topics[k].name.ru);
    sel.appendChild(option);
  });
  
  if (sel.options.length > 0) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (topics[state.flash.topic]) {
      sel.value = state.flash.topic;
    } else {
      state.flash.topic = sel.options[0].value;
      sel.value = state.flash.topic;
    }
  } else {
    sel.innerHTML = `<option value="">${state.ui.noData}</option>`;
    $("#flashcard").textContent = state.ui.noData;
    $("#fcPos").textContent = "0/0";
    return;
  }
  
  $("#fcSide").value = state.flash.side;
  
  // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–º—ã
  sel.addEventListener("change", () => {
    state.flash.topic = sel.value;
    resetDeck();
    drawCard();
    renderFavorites();
  });
  
  $("#fcSide").addEventListener("change", () => {
    state.flash.side = $("#fcSide").value;
    drawCard();
  });
  
  resetDeck();
  drawCard();
  renderFavorites();
}

function deckData() {
  return topics[state.flash.topic]?.words?.map(w => ({
    front: w.de, 
    back: w[lang] || w.ru, 
    raw: w
  })) || [];
}

function resetDeck() {
  state.flash.idx = 0;
  const arr = deckData();
  state.flash.order = [...Array(arr.length).keys()];
  shuffleDeck();
}

function shuffleDeck() {
  for (let i = state.flash.order.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [state.flash.order[i], state.flash.order[j]] = [state.flash.order[j], state.flash.order[i]];
  }
}

function drawCard() {
  const data = deckData();
  const total = data.length;
  
  if (total === 0) {
    $("#flashcard").textContent = state.ui.noData;
    $("#fcPos").textContent = "0/0";
    return;
  }
  
  // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å, –µ—Å–ª–∏ –≤—ã—à–ª–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
  if (state.flash.idx < 0) state.flash.idx = total - 1;
  if (state.flash.idx >= total) state.flash.idx = 0;
  
  const item = data[state.flash.order[state.flash.idx]];
  const mode = state.flash.side === "mix" ? 
    (Math.random() < 0.5 ? "front" : "back") : 
    state.flash.side;
  
  $("#flashcard").dataset.show = mode;
  $("#flashcard").textContent = mode === "front" ? item.front : item.back;
  $("#fcPos").textContent = `${state.flash.idx + 1}/${total}`;
}

function move(direction) {
  state.flash.idx += direction;
  drawCard();
}

function flip() {
  const fc = $("#flashcard");
  const mode = fc.dataset.show === "front" ? "back" : "front";
  fc.dataset.show = mode;
  
  const data = deckData();
  const item = data[state.flash.order[state.flash.idx]];
  fc.textContent = mode === "front" ? item.front : item.back;
}

function sayCurrent() {
  const data = deckData();
  if (data.length === 0) return;
  
  const item = data[state.flash.order[state.flash.idx]];
  const text = $("#flashcard").dataset.show === "front" ? item.front : item.raw.de;
  speak(text, "de-DE");
}

function toggleFavCurrent() {
  const data = deckData();
  if (data.length === 0) return;
  
  const item = data[state.flash.order[state.flash.idx]].raw;
  const id = `${item.de}|${item.ru}`;
  
  const idx = state.flash.favorites.findIndex(x => x.id === id);
  if (idx > -1) {
    state.flash.favorites.splice(idx, 1);
  } else {
    state.flash.favorites.push({...item, id});
  }
  
  localStorage.setItem("fav-cards", JSON.stringify(state.flash.favorites));
  renderFavorites();
  updateFavButton();
}

function updateFavButton() {
  const data = deckData();
  if (data.length === 0) return;
  
  const item = data[state.flash.order[state.flash.idx]].raw;
  const id = `${item.de}|${item.ru}`;
  const isFav = state.flash.favorites.some(x => x.id === id);
  
  $("#favCard").innerHTML = isFav ? "‚òÖ" : "‚òÜ";
  $("#favCard").setAttribute("aria-label", isFav ? 
    "–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ" : "–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ");
}

function renderFavorites() {
  const box = $("#favorites");
  box.innerHTML = "";
  
  if (state.flash.favorites.length === 0) {
    box.innerHTML = `<div class="dict-item">${state.ui.noData}</div>`;
    return;
  }
  
  state.flash.favorites.forEach(f => {
    const item = document.createElement("div");
    item.className = "dict-item";
    item.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <b>${escapeHTML(f.de)}</b>
          <div class="small">${escapeHTML(f[lang] || f.ru)}</div>
        </div>
        <div class="row">
          <button class="btn" aria-label="–û–∑–≤—É—á–∏—Ç—å —Å–ª–æ–≤–æ" data-action="speak-fav" data-word="${escapeHTML(f.de)}">
            <span aria-hidden="true">üîä</span>
          </button>
          <button class="btn" aria-label="–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ" data-action="remove-fav" data-id="${escapeHTML(f.id)}">‚úï</button>
        </div>
      </div>`;
    
    box.appendChild(item);
  });
  
  // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
  box.addEventListener("click", handleFavoritesClick);
  updateFavButton();
}

function handleFavoritesClick(e) {
  const button = e.target.closest("button");
  if (!button) return;
  
  if (button.dataset.action === "speak-fav") {
    speak(button.dataset.word, "de-DE");
  } 
  else if (button.dataset.action === "remove-fav") {
    const id = button.dataset.id;
    state.flash.favorites = state.flash.favorites.filter(x => x.id !== id);
    localStorage.setItem("fav-cards", JSON.stringify(state.flash.favorites));
    renderFavorites();
    drawCard(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
  }
}

/* ========= –ì–†–ê–ú–ú–ê–¢–ò–ö–ê ========= */
function buildGrammar() {
  const sel = $("#gramTopic");
  sel.innerHTML = "";
  
  let hasGrammar = false;
  
  topicKeys.forEach(tk => {
    topics[tk].grammar?.forEach((g, i) => {
      hasGrammar = true;
      const option = document.createElement("option");
      option.value = `${tk}|${i}`;
      option.textContent = `${escapeHTML(topics[tk].name[lang] || topics[tk].name.ru)} ‚Äî ${escapeHTML(g.title[lang] || g.title.ru)}`;
      sel.appendChild(option);
    });
  });
  
  if (!hasGrammar) {
    sel.innerHTML = `<option value="">${state.ui.noData}</option>`;
    $("#grammarBody").innerHTML = `<p class="small">${state.ui.noData}</p>`;
    return;
  }
  
  sel.addEventListener("change", renderGrammar);
  renderGrammar();
}

function renderGrammar() {
  const val = $("#gramTopic").value;
  const grammarBody = $("#grammarBody");
  
  if (!val) {
    grammarBody.innerHTML = `<p class="small">${state.ui.noData}</p>`;
    return;
  }
  
  const [tk, idxStr] = val.split("|");
  const idx = parseInt(idxStr, 10);
  const grammar = topics[tk]?.grammar?.[idx];
  
  if (!grammar) {
    grammarBody.innerHTML = `<p class="small">${state.ui.noData}</p>`;
    return;
  }
  
  grammarBody.innerHTML = grammar.html[lang] || grammar.html.ru;
}

/* ========= –î–ò–ê–õ–û–ì–ò ========= */
function buildDialogs() {
  const sel = $("#dlgTopic");
  sel.innerHTML = "";
  
  if (topicKeys.length === 0) {
    sel.innerHTML = `<option value="">${state.ui.noData}</option>`;
    $("#dialogsList").innerHTML = `<div class="dialog-item">${state.ui.noData}</div>`;
    return;
  }
  
  topicKeys.forEach(tk => {
    const option = document.createElement("option");
    option.value = tk;
    option.textContent = escapeHTML(topics[tk].name[lang] || topics[tk].name.ru);
    sel.appendChild(option);
  });
  
  sel.addEventListener("change", renderDialogs);
  renderDialogs();
}

function renderDialogs() {
  const tk = $("#dlgTopic").value || topicKeys[0];
  const body = $("#dialogsList");
  body.innerHTML = "";
  
  if (!topics[tk] || !topics[tk].dialogs || topics[tk].dialogs.length === 0) {
    body.innerHTML = `<div class="dialog-item">${state.ui.noData}</div>`;
    return;
  }
  
  topics[tk].dialogs.forEach(d => {
    const div = document.createElement("div");
    div.className = "dialog-item";
    div.innerHTML = `
      <div class="title">${escapeHTML(d.title[lang] || d.title.ru)}</div>
      <ul style="margin:8px 0 0;padding-left:18px">
        ${d.lines.map(l => `
          <li>
            <b>${escapeHTML(l.role)}:</b> 
            ${escapeHTML(l.de)} 
            <span class="small">‚Äî ${escapeHTML(l[lang] || l.ru)}</span>
          </li>
        `).join("")}
      </ul>`;
    
    body.appendChild(div);
  });
}

$("#playDlg").addEventListener("click", () => {
  const tk = $("#dlgTopic").value || topicKeys[0];
  const dialogs = topics[tk]?.dialogs;
  
  if (!dialogs || dialogs.length === 0) return;
  
  const firstDialog = dialogs[0];
  const sequence = firstDialog.lines.map(l => l.de).join(". ");
  speak(sequence, "de-DE");
});

/* ========= –û–ó–í–£–ß–ö–ê ========= */
function speak(text, locale = "de-DE") {
  if (!("speechSynthesis" in window)) {
    alert("–û–∑–≤—É—á–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º");
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —è–∑—ã–∫–∞
  const voices = speechSynthesis.getVoices();
  const supportedVoices = voices.filter(v => 
    v.lang.startsWith(locale.split('-')[0])
  );
  
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = supportedVoices.length > 0 ? supportedVoices[0].lang : locale;
  utterance.rate = 0.9;
  utterance.pitch = 1;
  
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utterance);
}

$("#speakBtn").addEventListener("click", () => {
  const locale = lang === "de" ? "de-DE" : lang === "az" ? "az-AZ" : "ru-RU";
  speak(state.ui.voiceHint, locale);
});

/* ========= –≠–ö–°–ü–û–†–¢ –í CSV ========= */
function exportCSV(tk) {
  try {
    const data = topics[tk]?.words;
    if (!data || data.length === 0) {
      alert(state.ui.exportError);
      return;
    }
    
    const rows = [["DE", lang.toUpperCase()]];
    data.forEach(w => rows.push([w.de, w[lang] || w.ru]));
    
    const csvContent = rows.map(row => 
      row.map(cell => 
        `"${String(cell || "").replace(/"/g, '""')}"`
      ).join(",")
    ).join("\n");
    
    const blob = new Blob([`\uFEFF${csvContent}`], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement("a");
    a.href = url;
    a.download = `${escapeHTML(topics[tk].name[lang] || topics[tk].name.ru)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    console.log("CSV export successful");
  } catch (error) {
    console.error("CSV export error:", error);
    alert(state.ui.exportError);
  }
}

/* ========= –û–ë–©–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø ========= */
// –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—â–∏—Ö —Å–æ–±—ã—Ç–∏–π
document.addEventListener("click", (e) => {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ —Å–ª–æ–≤–∞—Ä–µ
  const favBtn = e.target.closest(".dict-item .favorite");
  if (favBtn) {
    const data = JSON.parse(favBtn.dataset.word);
    const favId = `${data.de}|${data.ru}`;
    const idx = state.flash.favorites.findIndex(x => x.id === favId);
    
    if (idx > -1) {
      state.flash.favorites.splice(idx, 1);
    } else {
      state.flash.favorites.push({...data, id: favId});
    }
    
    localStorage.setItem("fav-cards", JSON.stringify(state.flash.favorites));
    buildFlashcards();
    renderDict($("#dictTopic").value, $("#searchInput").value.trim());
    return;
  }
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –æ–∑–≤—É—á–∫–∏ –≤ —Å–ª–æ–≤–∞—Ä–µ
  const speakBtn = e.target.closest(".dict-item [data-action='speak-word']");
  if (speakBtn) {
    speak(speakBtn.dataset.word, "de-DE");
    return;
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
$("#flashcard").addEventListener("click", flip);
$("#flashcard").addEventListener("keydown", e => {
  if (e.key === " " || e.key === "Enter") {
    e.preventDefault();
    flip();
  }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener("DOMContentLoaded", () => {
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–æ–¥ –≤ —Ñ—É—Ç–µ—Ä–µ
  $("#year").textContent = new Date().getFullYear();
  
  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
  setupNavigation();
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  applyUI();
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
  $("#prevCard").addEventListener("click", () => move(-1));
  $("#nextCard").addEventListener("click", () => move(1));
  $("#flipCard").addEventListener("click", flip);
  $("#shuffleCard").addEventListener("click", () => { shuffleDeck(); drawCard(); });
  $("#ttsCard").addEventListener("click", sayCurrent);
  $("#favCard").addEventListener("click", toggleFavCurrent);
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
  $("#accessibilityToggle").addEventListener("click", (e) => {
    e.preventDefault();
    alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏: —É–≤–µ–ª–∏—á–∏—Ç—å —à—Ä–∏—Ñ—Ç, –≤—ã—Å–æ–∫–æ–∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º –∏ –¥—Ä—É–≥–∏–µ –æ–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö.");
  });
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤ (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤)
  if ('onvoiceschanged' in speechSynthesis) {
    speechSynthesis.onvoiceschanged = () => {
      // –ì–æ–ª–æ—Å–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å
    };
  }
});
</script>
</body>
</html>
